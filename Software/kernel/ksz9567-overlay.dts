/*
 * Universal device tree overlay for SPI devices
 */

/dts-v1/;
/plugin/;

#include <dt-bindings/gpio/gpio.h>
/ {
	compatible = "brcm,bcm2835";


    fragment@0 {
	target = <&genet>;
	my_eth: myeth@0 {
		max-speed = <1000>;
	};
    };

    fragment@1 { // ksz9567 phy
        target = <&spi0>;
        __overlay__ {
            status = "okay";

            ksz9567@0 {
                compatible = "microchip,ksz9567";
                reg = <0>;                         // CS0
                spi-max-frequency = <500000>;       // 500kHz, safe for startup
                status = "okay";

			ports {
				#address-cells = <1>;
				#size-cells = <0>;
				port@0 {
					reg = <0>;
					label = "lan1";
					phy-mode = "internal";
				};
				port@1 {
					reg = <1>;
					label = "lan2";
					phy-mode = "internal";
				};
				port@2 {
					reg = <2>;
					label = "lan3";
					phy-mode = "internal";
				};
				port@3 {
					reg = <3>;
					label = "lan4";
					phy-mode = "internal";
				};
				port@4 {
					reg = <4>;
					label = "lan5";
					phy-mode = "internal";
				};
				port@5 {
					reg = <6>;
					label = "lan6-sfp";
					phy-mode = "rgmii";
					fixed-link {
						speed = <1000>;
						full-duplex;
						pause;
					};
				};
				port@6 {
					reg = <5>;
					label = "cpu";
					//phy-mode = "rgmii-id";
					phy-mode = "rgmii-txid";
					rx-internal-delay-ps = <2000>;
					tx-internal-delay-ps = <2000>;
					ethernet = <&genet>;
					//phy-handle = <&phy1>;
					//mdio = <&mdio0>;
					fixed-link {
						speed = <1000>;
						full-duplex;
						pause;
					};
				};
			};
		};
	    };
	};
	fragment@2 { // ksz9031 rgmii phy between ksz9567 and CM4
		target-path = "/";
		__overlay__ {
			mdio0: mdio {
				compatible = "virtual,mdio-gpio";
				// MDC = cm4 pin 54 gpio4 , MDIO = cm4 pin 50 gpio 17
				gpios = <&gpio 4 0>, <&gpio 17 0>;
				#address-cells = <1>;
				#size-cells = <0>;
				status = "okay";
				phy1: ethernet-phy@3 {
					compatible = "ethernet-phy-ieee802.3-c22";
					reg = <0>;
					//reset-gpios = <&gpio 24 GPIO_ACTIVE_LOW>; // brd_rst_n cm4 pin 45 gpio 24	
				};
			};
		};
	};


	   fragment@3 {
			target-path = "/";
			__overlay__ {
				    i2c_muxsel: i2c@9 {
					reg = <9>;
					compatible = "i2c-gpio";
					gpios = <&gpio 27 (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN) /* SDA */
						 &gpio 22 (GPIO_ACTIVE_HIGH|GPIO_OPEN_DRAIN) /* SCL */>;
					i2c-gpio,delay-us = <2>;        /* ~100 kHz */
					#address-cells = <1>;
					#size-cells = <0>;

						tca6408: gpio@21 {
							compatible = "ti,tca6408";
							reg = <0x21>;
							gpio-controller;
							#gpio-cells = <2>;
							status = "okay";
							gpio-line-names = "SMA4_MUX_SAI", "SMA4_MUX_SBI",
								"SMA2_MUX_SAI", "SMA2_MUX_SBI",
								"SMA1_MUX_SAO", "SMA1_MUX_SBO",
								"SMA1_MUX_SAI", "SMA1_MUX_SBI";
						};
				    };
				};
		};

};
